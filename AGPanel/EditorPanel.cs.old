using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

using UnityEngine;
using ClickThroughFix;

namespace AGPanel
{
    [KSPAddon(KSPAddon.Startup.EditorAny, false)]
    class EditorPanel : MonoBehaviour
    {
        int editorWindowID;

        const float WIDTH = 350;
        const float HEIGHT = 300;
        public static Rect editorWindowPos = new Rect(Screen.width / 2 - WIDTH / 2 + 100, Screen.height / 2 - HEIGHT / 2 - 100, WIDTH, HEIGHT);

        float editorPanelX = 0f;
        float editorPanelY = 0f;

        //public static List<String> labelList = new List<string> {
        //    "Custom01",
        //    "Custom02",
        //    "Custom03",
        //    "Custom04",
        //    "Custom05",
        //    "Custom06",
        //    "Custom07",
        //    "Custom08",
        //    "Custom09",
        //    "Custom10",
        //    "Light",
        //    "RCS",
        //    "SAS",
        //    "Brakes",
        //    "Abort",
        //    "Gear"
        //};

        //public class LabelRec
        //{
        //    public int ActionGroup;
        //    public String Label;
        //    public Boolean Active;
        //    public Boolean Visible = false;
        //    public int ButtonType = 0;
        //
        //    public enum BtnTypes
        //    {
        //        Plain,
        //        Toggle,
        //        SingleUse
        //    };
        //
        //    public LabelRec(int actionGroup, string label)
        //    {
        //        this.ActionGroup = actionGroup;
        //        this.Label = label;
        //        this.Active = false;
        //        this.Visible = false;
        //        this.ButtonType = 0;
        //    }
        //
        //    public String Serialise()
        //    {
        //        return (this.Visible ? "1" : "0") + this.ButtonType.ToString() + this.Label;
        //    }
        //}

        public static List<AGPanel.LabelRec> editorLabelList = new List<AGPanel.LabelRec> {
            new AGPanel.LabelRec(1, "Custom01"),
            new AGPanel.LabelRec(2, "Custom02"),
            new AGPanel.LabelRec(3, "Custom03"),
            new AGPanel.LabelRec(4, "Custom04"),
            new AGPanel.LabelRec(5, "Custom05"),
            new AGPanel.LabelRec(6, "Custom06"),
            new AGPanel.LabelRec(7, "Custom07"),
            new AGPanel.LabelRec(8, "Custom08"),
            new AGPanel.LabelRec(9, "Custom09"),
            new AGPanel.LabelRec(10, "Custom10"),
            new AGPanel.LabelRec(11, "Light"),
            new AGPanel.LabelRec(12, "RCS"),
            new AGPanel.LabelRec(13, "SAS"),
            new AGPanel.LabelRec(14, "Brakes"),
            new AGPanel.LabelRec(15, "Abort"),
            new AGPanel.LabelRec(16, "Gear"),
        };

        internal static String _AssemblyName { get { return System.Reflection.Assembly.GetExecutingAssembly().GetName().Name; } }

        void Start()
        {
            editorWindowID = UnityEngine.Random.Range(1000, 20000000) + _AssemblyName.GetHashCode();

            if (HighLogic.LoadedSceneIsEditor)
            {
                GameEvents.onAboutToSaveShip.Add(StoreAGPDataInPartModule);
                GameEvents.onEditorLoad.Add(LoadAGPDataInEditor);
            }
            else if (HighLogic.LoadedSceneIsFlight)
            {
                AGPanel.activeVessel = FlightGlobals.ActiveVessel;
            }
            AGPanel.LoadSettings();
        }

        void OnGUI()
        {
            GUI.skin = HighLogic.Skin;
            if (AGPanel.visible)
                editorWindowPos = ClickThruBlocker.GUILayoutWindow(editorWindowID, editorWindowPos, DrawEditorWindow, "Action Group Label Editor");
            //editorWindowPos = GUILayout.Window(editorWindowID, editorWindowPos, DrawEditorWindow, "AG Editor Panel");
            if (editorWindowPos.x != editorPanelX || editorWindowPos.y != editorPanelY)
            {
                AGPanel.SaveSettings();
                editorPanelX = editorWindowPos.x;
                editorPanelY = editorWindowPos.y;
            }
                
        }

        void DrawEditorWindow(int id)
        {
            //Needs a lot of work formatting the layout correctly and making pretty-er 

            GUI.enabled = true;

            GUILayout.BeginVertical();

            GUILayout.BeginHorizontal();
            GUILayout.Label("Action Group");
            GUILayout.Label("Vis");               // Make button active/visible in flight panel
            GUILayout.Label("Type");               // Make button in flight panel a toggle (not implemented but planing ahead)
            GUILayout.EndHorizontal();

            GUIStyle ToggleButton = new GUIStyle()
            {
                margin = new RectOffset(HighLogic.Skin.button.margin.left, HighLogic.Skin.button.margin.right, 5, 5),
                fixedHeight = 25f,
            };
            
            foreach (AGPanel.LabelRec rec in AGPanel.labelList)
            {
                GUILayout.BeginHorizontal();
                GUILayout.Label(String.Format("AG" + rec.ActionGroup + ": "));
                rec.Label = GUILayout.TextField(rec.Label, 25);
                rec.Visible = GUILayout.Toggle(rec.Visible, "");
                
                //Checkout Trajectories for adding label to end of slider indicating value
                rec.ButtonType = Convert.ToInt32(GUILayout.HorizontalSlider((float)rec.ButtonType, 0.0f, 2.0f));
                //Possible alternative if can make btns small enough
                //rec.ButtonType = GUILayout.Toolbar(rec.ButtonType, Enum.GetNames(typeof(LabelRec.BtnTypes)));
                GUILayout.EndHorizontal();
            }

            GUILayout.EndVertical();

            GUI.DragWindow();

        }

        public void StoreAGPDataInPartModule(ShipConstruct s)
        {
            AGPModule storageModule;

            if (EditorLogic.RootPart.Modules.Contains("AGPModule"))
            {
                storageModule = EditorLogic.RootPart.Modules.GetModule<AGPModule>();

                foreach (AGPanel.LabelRec rec in AGPanel.labelList)
                {
                    storageModule.Fields.SetValue("AG" + rec.ActionGroup, rec.Serialise());
                    //Debug.Log("AGPanel: EditorPanel: StoreAGPData: SetValue: AG" + rec.ActionGroup + " = " + rec.Serialise());
                }
            }
        }

        public void LoadAGPDataInEditor(ShipConstruct s, KSP.UI.Screens.CraftBrowserDialog.LoadType loadType)
        {
            // This is not working, it is pulling default data from somewhere other than the .craft files, maybe its
            // holding on to the values from before the load?
            // I think I will need to change EditorLogic.RootPart for something else???
            
            
            AGPModule storageModule = EditorLogic.RootPart.Modules.GetModule<AGPModule>();

            for (int i = 0; i < AGPanel.labelList.Count; i++)
            {
                String value = storageModule.Fields.GetValue<String>("AG" + (i + 1));

                AGPanel.labelList[i].Visible = value.Substring(0, 1).Equals("1");
                //AGPanel.labelList[i].Active = value.Substring(1, 1).Equals("1");
                AGPanel.labelList[i].Active = false;
                AGPanel.labelList[i].ButtonType = (int.Parse(value.Substring(2, 1)));
                AGPanel.labelList[i].Label = value.Substring(3);
                //Debug.Log("AGPanel: EditorPanel: LoadAGPData: value = " + value);
                //Debug.Log("AGPanel: EditorPanel: LoadAGPData: labeList[" + i + "].Label = " + value.Substring(3));
            }
        }
    }
}
